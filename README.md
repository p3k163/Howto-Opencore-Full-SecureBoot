# Howto-Opencore-Full-Secureboot

This tutorial contains knowledge/code from other authors.  
The original author owns the copyright to the relevant content.  
The source of all the content involved is listed below.  
This tutorial only simplifies the relevant content, it is recommended to visit the original author’s link to learn more details.

References:  
[1]. Taming UEFI SecureBoot https://sudonull.com/post/92362-Taming-UEFI-SecureBoot
[2]. OpenCore https://github.com/acidanthera/OpenCorePkg
[3]. Opencore Post-install https://dortania.github.io/OpenCore-Post-Install/#how-to-follow-this-guide

Before we start:
1. Make sure the Secure Boot function in BIOS is unlocked.

Preparation:
1. Download latest OpenCore release (https://github.com/acidanthera/OpenCorePkg).
2. Download any Linux installer or prepare a functional Linux system (Ubuntu, Debian, etc.).
3. Download ProperTree (https://github.com/corpnewt/ProperTree).
4. Microsoft KEK CA 2011 cert (http://go.microsoft.com/fwlink/?LinkId=321185).
5. Microsoft Windows Production CA 2011 cert (http://go.microsoft.com/fwlink/?LinkID=321192).
6. Microsoft UEFI driver signing CA 2011 cert (http://go.microsoft.com/fwlink/?LinkId=321194).
7. An empty thumb drive.

Let's go:
1. Add password to protect sensitive operations.
Unpack downloaded OpenCore release and go to ./OpenCore-a.b.c-RELEASE/Utilities/ocpasswordgen  
Open terminal and drag ocpasswordgen executable file to the terminal window then press enter  
Type Password then press enter  
Unpack downloaded ProperTree and go to ./ProperTree  
Open a new Terminal window and drag ProperTree.command to the terminal window then press enter  
Mount EFI partition  
Load config.plist to ProperTree and navigate to ROOT->MISC->Security 
Set EnablePassword to True  
Copy PasswordHash generated by ocpasswordgen to PasswordHash in ProperTree  
Copy PasswordSalt generated by ocpasswordgen to PasswordSalt in ProperTree  
Save config.plist and try to boot OpenCore, wait for the picker check whether the password is required  
2. Enable Apple Secure Boot.
Mount EFI partition  
Unpack downloaded ProperTree and go to ./ProperTree  
Open a new Terminal window and drag ProperTree.command to the terminal window then press enter  
Load config.plist to ProperTree and navigate to ROOT->MISC->Security  
Set SecureBootModel to proper value according to the model using (Only select x86legacy if the model is not in the list, it is no matter whether T2 is actually present in your physical machine)  
• j137 — iMacPro1,1 (December 2017)  
• j680 — MacBookPro15,1 (July 2018)  
• j132 — MacBookPro15,2 (July 2018)  
• j174 — Macmini8,1 (October 2018)  
• j140k — MacBookAir8,1 (October 2018)  
• j780 — MacBookPro15,3 (May 2019)  
• j213 — MacBookPro15,4 (July 2019)  
• j140a — MacBookAir8,2 (July 2019)  
• j152f — MacBookPro16,1 (November 2019)  
• j160 — MacPro7,1 (December 2019)  
• j230k — MacBookAir9,1 (March 2020)  
• j214k — MacBookPro16,2 (May 2020)  
• j223 — MacBookPro16,3 (May 2020)  
• j215 — MacBookPro16,4 (June 2020)  
• j185 — iMac20,1 (August 2020)  
• j185f — iMac20,2 (August 2020)  
• x86legacy — Macs without T2 chip and VMs. Minimum macOS 11.0.1 (20B29)  
Generate ApECID with Python3 (python3 -c 'import secrets; print(secrets.randbits(64))')  
Copy the output number to ApECID in ProperTree  
Set DmgLoading to Signed (or Disabled to achieve maximum security)  
3. Generate hashes to protect OpenCore files, this will avoid any modification to files (including config.plist).
Mount EFI partition  
Unpack downloaded OpenCore release copy ./OpenCore-a.b.c-RELEASE/Utilities to the root of EFI partition  
Open terminal and change directory to /Volumes/EFI/Utilities/CreateVault  
Type ./sign.command in terminal then press enter  
Unpack downloaded ProperTree and go to ./ProperTree  
Open a new Terminal window and drag ProperTree.command to the terminal window then press enter  
Load config.plist to ProperTree and navigate to ROOT->MISC->Security  
Set Vault to Secure  
4. Boot Linux installer or Linux system and install tools.  
Ubuntu: sudo apt install efitools openssl sbsigntool  
5. Generate Platform Key, Key Exchange Key and Image Signing Key. You may create any passwords during this process but you need to keep them in mind.
openssl req -new -x509 -newkey rsa:2048 -sha256 -days 365 -subj "/CN=Platform Key" -keyout PK.key -out PK.pem  
openssl req -new -x509 -newkey rsa:2048 -sha256 -days 365 -subj "/CN=Key Exchange Key" -keyout KEK.key -out KEK.pem  
openssl req -new -x509 -newkey rsa:2048 -sha256 -days 365 -subj "/CN=Image Signing Key" -keyout ISK.key -out ISK.pem  
6. Convert Microsoft certs to pem format.
openssl x509 -in MicCorKEKCA2011_2011-06-24.crt -inform DER -out MsKEK.pem -outform PEM  
openssl x509 -in MicWinProPCA2011_2011-10-19.crt -inform DER -out MsWin.pem -outform PEM  
openssl x509 -in MicCorUEFCA2011_2011-06-27.crt -inform DER -out UEFI.pem -outform PEM  
7. Convert keys to esl format.
cert-to-efi-sig-list -g "$(uuidgen)" PK.pem PK.esl  
cert-to-efi-sig-list -g "$(uuidgen)" KEK.pem KEK.esl  
cert-to-efi-sig-list -g "$(uuidgen)" ISK.pem ISK.esl  
cert-to-efi-sig-list -g "$(uuidgen)" MsWin.pem MsWin.esl  
cert-to-efi-sig-list -g "$(uuidgen)" UEFI.pem UEFI.esl  
8. Copy all the esl keys to a new folder then combine KEKs and ISKs.
cat KEK.esl MsKEK.esl > NewKEK.esl  
cat ISK.esl MsWin.esl UEFI.esl > db.esl  
9. Copy NewKEK.esl, KEK.pem, KEK.key, PK.key, PK.pem, PK.esl, db.esl to a new folder and rename NewKEK.esl to KEK.esl, then sign esls with PK.
sign-efi-sig-list -k PK.key -c PK.pem PK PK.esl PK.auth  
sign-efi-sig-list -k PK.key -c PK.pem KEK KEK.esl KEK.auth  
sign-efi-sig-list -k KEK.key -c KEK.pem db db.esl db.auth  
10. Format thumb drive to FAT-32 format and copy PK.auth, KEK.auth, db.auth to thumb drive.
11. Copy each OpenCore efi file to the folder contains ISK.key and ISK.pem.
EFI Drivers (/EFI/OC/Drivers): AudioDxe.efi, NvmExpressDxe.efi, OpenCanopy.efi, OpenPartitionDxe.efi, OpenRuntime.efi, etc.  
EFI Tools (/EFI/OC/Tools): CleanNvram.efi, OpenShell.efi, VerifyMsrE2.efi, etc.  
OpenCore (/EFI/OC): OpenCore.efi  
BootX64 (/EFI/BOOT): BOOTx64.efi  
12. Sign each OpenCore efi file.
sbsign --key ISK.key --cert ISK.pem --output Signed_AudioDxe.efi AudioDxe.efi  
sbsign --key ISK.key --cert ISK.pem --output Signed_NvmExpressDxe.efi NvmExpressDxe.efi  
sbsign --key ISK.key --cert ISK.pem --output Signed_CleanNvram.efi CleanNvram.efi  
sbsign --key ISK.key --cert ISK.pem --output Signed_OpenShell.efi OpenShell.efi  
sbsign --key ISK.key --cert ISK.pem --output Signed_OpenCore.efi OpenCore.efi  
Sign each efi file...  
Rename Signed_.efi to original name then replace the unsigned efi files.
13. Copy MacOS boot file to the root of thumb disk (/System/Library/CoreServices/boot.efi).
14. Plug in the thumb disk contains .auth files then boot into BIOS setting.
Go to Security->Secure Boot  
Select Restore Factory Keys then reboot in to BIOS setting again  
Set Secure Boot Mode to Custom  
Go to Key Management  
Scroll down to Platform Key(PK) then press enter, select Update, then select No to load auth file from thumb disk, select File system contains \USB(x,x)\, navigate to the PK.auth then press enter  
Scroll down to Key Exchange Keys then press enter, select Update, then select No to load auth file from thumb disk, select File system contains \USB(x,x)\, navigate to the KEK.auth then press enter  
Scroll down to Authorized Signatures then press enter, select Update, then select No to load auth file from thumb disk, select File system contains \USB(x,x)\, navigate to the db.auth then press enter  
Screoll up to Enroll EFI Image, select File system contains \USB(x,x)\, navigate to the boot.efi then press enter  
15. Reboot to OpenCore and check whether the system will boot properly (both MacOS and Windows).

Note:
1. After setting up the OpenCore password, boot to default system doesn't require any password, you can set MISC->Boot->ShowPicker to False to hide password UI when booting to default system. You can still access the picker UI by keep presssing ESC during loading the OpenCore.
2. After setting up the ApECID, you may need to reinstall the whole system or personalise your MacOS, see below instructions come from OpenCore document:
To personalise an existing operating system, use the bless command after loading to macOS DMG recovery. Mount the system volume partition, unless it has already been mounted, and execute the following command:  
bless bless --folder "/Volumes/Macintosh HD/System/Library/CoreServices" --bootefi --personalize  
